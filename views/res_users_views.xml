<?xml version="1.0" encoding="utf-8"?>
<odoo>
    <!-- Extend User Form View -->
    <record id="view_users_form_oauth_modern" model="ir.ui.view">
        <field name="name">res.users.form.oauth.modern</field>
        <field name="model">res.users</field>
        <field name="inherit_id" ref="base.view_users_form"/>
        <field name="arch" type="xml">
            <!-- Add OAuth page to notebook -->
            <xpath expr="//notebook" position="inside">
                <page string="OAuth Authentication" name="oauth_modern">
                    <group>
                        <group string="OAuth Provider" name="oauth_provider">
                            <field name="oauth_provider_id" readonly="0"/>
                            <field name="oauth_uid" readonly="1"/>
                            <field name="oauth_enabled"/>
                            <field name="force_oauth_login" 
                                   attrs="{'invisible': [('oauth_provider_id', '=', False)]}"/>
                        </group>
                        <group string="OAuth Status" name="oauth_status">
                            <field name="oauth_last_sync" readonly="1"/>
                            <field name="oauth_token_expiry" readonly="1" 
                                   groups="base.group_system"/>
                            <label for="oauth_access_token" string="Has Access Token" 
                                   groups="base.group_system"/>
                            <div groups="base.group_system">
                                <span attrs="{'invisible': [('oauth_access_token', '=', False)]}">
                                    <i class="fa fa-check text-success"/> Yes
                                </span>
                                <span attrs="{'invisible': [('oauth_access_token', '!=', False)]}">
                                    <i class="fa fa-times text-danger"/> No
                                </span>
                            </div>
                            <label for="oauth_refresh_token" string="Has Refresh Token" 
                                   groups="base.group_system"/>
                            <div groups="base.group_system">
                                <span attrs="{'invisible': [('oauth_refresh_token', '=', False)]}">
                                    <i class="fa fa-check text-success"/> Yes
                                </span>
                                <span attrs="{'invisible': [('oauth_refresh_token', '!=', False)]}">
                                    <i class="fa fa-times text-danger"/> No
                                </span>
                            </div>
                        </group>
                    </group>
                    
                    <group string="Actions" name="oauth_actions">
                        <button name="action_sync_oauth_info" 
                                type="object" 
                                string="Sync OAuth Info" 
                                class="btn-primary"
                                attrs="{'invisible': ['|', ('oauth_provider_id', '=', False), ('oauth_access_token', '=', False)]}"/>
                        <button name="_refresh_oauth_token" 
                                type="object" 
                                string="Refresh Token" 
                                class="btn-secondary"
                                groups="base.group_system"
                                attrs="{'invisible': ['|', ('oauth_provider_id', '=', False), ('oauth_refresh_token', '=', False)]}"/>
                        <button name="action_unlink_oauth" 
                                type="object" 
                                string="Unlink OAuth" 
                                class="btn-danger"
                                confirm="Are you sure you want to unlink OAuth from this account? The user will need to set a password to login."
                                attrs="{'invisible': ['|', ('oauth_provider_id', '=', False), ('force_oauth_login', '=', True)]}"/>
                    </group>
                    
                    <group string="OAuth User Info (Debug)" 
                           name="oauth_debug" 
                           groups="base.group_no_one"
                           attrs="{'invisible': [('oauth_user_info', '=', False)]}">
                        <field name="oauth_user_info" readonly="1" widget="ace" options="{'mode': 'json'}"/>
                    </group>
                </page>
            </xpath>
            
            <!-- Add OAuth indicator in header -->
            <xpath expr="//div[@class='oe_title']" position="after">
                <div attrs="{'invisible': [('oauth_provider_id', '=', False)]}" 
                     class="alert alert-info">
                    <i class="fa fa-info-circle"/> 
                    This user authenticates via OAuth with 
                    <strong><field name="oauth_provider_id" readonly="1" style="display: inline;"/></strong>
                </div>
            </xpath>
        </field>
    </record>
    
    <!-- User Tree View - Add OAuth indicator -->
    <record id="view_users_tree_oauth_modern" model="ir.ui.view">
        <field name="name">res.users.tree.oauth.modern</field>
        <field name="model">res.users</field>
        <field name="inherit_id" ref="base.view_users_tree"/>
        <field name="arch" type="xml">
            <xpath expr="//field[@name='login_date']" position="after">
                <field name="oauth_provider_id" optional="show"/>
                <field name="oauth_enabled" widget="boolean_toggle" optional="hide"/>
            </xpath>
        </field>
    </record>
    
    <!-- User Search View - Add OAuth filters -->
    <record id="view_users_search_oauth_modern" model="ir.ui.view">
        <field name="name">res.users.search.oauth.modern</field>
        <field name="model">res.users</field>
        <field name="inherit_id" ref="base.view_users_search"/>
        <field name="arch" type="xml">
            <xpath expr="//filter[@name='inactive']" position="after">
                <separator/>
                <filter string="OAuth Users" 
                        name="oauth_users" 
                        domain="[('oauth_provider_id', '!=', False)]"/>
                <filter string="OAuth Required" 
                        name="oauth_required" 
                        domain="[('force_oauth_login', '=', True)]"/>
                <filter string="Non-OAuth Users" 
                        name="non_oauth_users" 
                        domain="[('oauth_provider_id', '=', False)]"/>
            </xpath>
            <xpath expr="//group" position="inside">
                <filter string="OAuth Provider" 
                        name="group_oauth_provider" 
                        context="{'group_by': 'oauth_provider_id'}"/>
            </xpath>
        </field>
    </record>
    
    <!-- Action for OAuth User Management -->
    <record id="action_oauth_users" model="ir.actions.act_window">
        <field name="name">OAuth Users</field>
        <field name="res_model">res.users</field>
        <field name="view_mode">tree,form</field>
        <field name="domain">[('oauth_provider_id', '!=', False)]</field>
        <field name="context">{'search_default_group_oauth_provider': 1}</field>
        <field name="help" type="html">
            <p class="o_view_nocontent_empty_folder">
                No OAuth users found
            </p>
            <p>
                Users will appear here once they authenticate using OAuth providers.
            </p>
        </field>
    </record>
    
    <!-- Menu item for OAuth Users -->
    <menuitem id="menu_oauth_users"
              name="OAuth Users"
              parent="base.menu_users"
              action="action_oauth_users"
              sequence="15"/>
</odoo>